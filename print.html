<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Introduction to Sorock</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon-de23e50b.svg">
        <link rel="shortcut icon" href="favicon-8114d1fc.png">
        <link rel="stylesheet" href="css/variables-8adf115d.css">
        <link rel="stylesheet" href="css/general-2459343d.css">
        <link rel="stylesheet" href="css/chrome-ae938929.css">
        <link rel="stylesheet" href="css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex-002ae6ee.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc-3c5fd17f.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">Introduction to Sorock</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <h1 id="introduction-to-sorock"><a class="header" href="#introduction-to-sorock">Introduction to Sorock</a></h1>
<p><img src="images/soroku.jpg" alt="Cover Image"></p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="multi-raft"><a class="header" href="#multi-raft">Multi-Raft</a></h1>
<p><a href="https://raft.github.io/">Raft</a> consensus algorithm is nowadays a widely used building block of distributed applications.
The algorithm is about consensus on the sequence of log entries, which are applied to a state machine.
When the two log entries are identical, then the resulting state is identical too.
In this sense, it is also called <strong>replicated state machine</strong>.</p>
<p>The typical usage of the Raft algorithm is to implement a distributed key-value store.
However, naive implementation will suffer from scalability issues due to the seriality of the algorithm.
Let’s consider putting (k1,v1) and (k2,v2) in the data store, naive implementation can’t handle these two concurrently
because the operations are serialized.</p>
<p>Sharding is a common solution to this kind of problem.
If the k1 and k2 are enough distant in the key space, then the operations can be handled concurrently
by sharded Raft clusters.
Since we can split the single Raft cluster into multiple small Raft clusters,
it naturally addresses the capacity scalability problem at the same time.
TiKV uses this technique (<a href="https://tikv.org/deep-dive/scalability/multi-raft/">ref</a>).</p>
<p><img src="images/multi-raft-tikv.png" alt=""></p>
<p>There are two ways of implementing a multi-raft.
One is deploying multiple Raft clusters independently.
One of the problems of this approach is that resources like IP addresses or ports must be
allocated per node to identify them.
This introduces unnecessary complexity in deployment.
Another problem is that shards can’t share the resources efficiently.
In the implementation of a key-value store, the embedded datastore should be shared among the shards
for efficient I/O like write batching.
For these problems, I will take the second approach.</p>
<p>sorock implements <strong>in-process multi-raft</strong>.
As the name implies, sorock allows you to place multiple <strong>Raft processes</strong> in a single gRPC server process.
These Raft processes can form a Raft cluster on independent <strong>shards</strong>.</p>
<p><img src="images/multi-raft.png" alt=""></p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="heartbeat-multiplexing"><a class="header" href="#heartbeat-multiplexing">Heartbeat Multiplexing</a></h1>
<p>In Raft, leader is responsible for periodically sending heartbeats to all followers to maintain the leadership.
In Multi-Raft, without any optimization load from the the heartbeats can be non-negligible.
However, we can optimize to reduce the heartbeat RPCs by multiplexing the heartbeats from different shards.</p>
<h2 id="problem-of-naive-implementation"><a class="header" href="#problem-of-naive-implementation">Problem of naive implementation</a></h2>
<p>In the following diagram, we have two nodes Node1 and Node2 and there are two shards.
A Process is a leader if it is denoted with an asterisk (*):
P1 is sending the heartbeats to the P3 and P2 to P4 as well.
So there are two RPC messages sent from P1 to P3 and P2 to P4 independently.</p>
<pre class="mermaid">graph LR
  subgraph Node1
    P1(P1*)
    P2(P2*)
  end
  subgraph Node2
    P3(P3)
    P4(P4)
  end
  P1 --&gt;|heartbeat| P3
  P2 --&gt; P4
</pre>

<h2 id="multiplexing-heartbeats"><a class="header" href="#multiplexing-heartbeats">Multiplexing heartbeats</a></h2>
<p>To reduce the number of RPCs to only one, we can introduce multiplexer and demultiplexer in the nodes.
The two heartbeats are buffered in the multiplexer and sent in a batched RPC to the destination node.
In the destination node, the demultiplexer will split the batched RPC into individual heartbeats
and send them to the corresponding processes.</p>
<pre class="mermaid">graph LR
  subgraph Node1
    P1(P1*)
    P2(P2*)
    MUX(Mux)
  end
  subgraph Node2
    DEMUX(Demux)
    P3(P3)
    P4(P4)
  end
  P1 --&gt; MUX
  P2 --&gt; MUX
  MUX --&gt; DEMUX
  DEMUX --&gt; P3
  DEMUX --&gt; P4
</pre>

<p>In this case the reduction rate is 2.
But what would be the reduction rate in general.
Let’s do some math.</p>
<h2 id="math-reduction-rate"><a class="header" href="#math-reduction-rate">Math: Reduction rate</a></h2>
<p>Let’s consider there are N nodes and L shards.
Each shard have K replication and leader processes are
balanced among the nodes.</p>
<p>In this case,
the total number of heartbeats sent in period is LK.
And the total directed paths connecting two nodes is N(N-1) and
these heartbeats are evenly attributed to these paths.
Therefore, the number of heartbeats sent in each path is LK/(N(N-1))
and this is the reduction rate.
For example, if there are 5 nodes and 1000 shards with 3 replication,
the reduction rate is 150.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="batched-write"><a class="header" href="#batched-write">Batched Write</a></h1>
<p>In multi-raft, multiple shards process write requests. Conceptually, each shard maintains its own log for entry insertion.</p>
<p>Having a physically independent log for each shard isn’t efficient as each write requires a transaction to persist the data on the storage.</p>
<p>However, an optimization technique called “batching” can be used. Here, each shard maintains a virtual log, and the entries are temporarily queued in a shared queue. These queued entries are then processed in a single transaction, reducing the number of transactions.</p>
<p>This approach often presents a throughput versus latency dilemma. However, this implementation increases throughput without sacrificing latency.</p>
<pre class="mermaid">graph LR
  CLI(Client)

  subgraph P1
    T1(redb::Table)
  end
  subgraph P2
    T2(redb::Table)
  end
  subgraph P3
    T3(redb::Table)
  end

  subgraph Reaper
    Q(Queue)
  end
  DB[(redb::Database)]

  CLI --&gt;|entry| T1
  CLI --&gt; T2
  CLI --&gt; T3
  T1 --&gt;|lazy entry| Q
  T2 --&gt; Q
  T3 --&gt; Q
  Q --&gt;|transaction| DB

</pre>

<div style="break-before: page; page-break-before: always;"></div>
<h1 id="raft-process"><a class="header" href="#raft-process">Raft Process</a></h1>
<p>The core of multi-raft is Raft process.
Each multi-raft server has one or more Raft processes.</p>
<p>To implement multi-raft,
sorock implements Raft process as it is agnostic to
detailed node communications through gRPC.
Since the Raft process doesn’t know about the IO,
we call it <strong>Pure Raft</strong>.</p>
<p><img src="images/raft-process.png" alt=""></p>
<p>To make Raft process to communicate with other Raft processes
through network, <code>RaftDriver</code> must be provided.
Everything about actual network communication is encapsulated under <code>RaftDriver</code>.</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl RaftProcess {
    pub async fn new(
        app: impl RaftApp,
        log_store: impl RaftLogStore,
        ballot_store: impl RaftBallotStore,
        driver: RaftDriver,
    ) -&gt; Result&lt;Self&gt; {
<span class="boring">}</span></code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="multi-threading"><a class="header" href="#multi-threading">Multi Threading</a></h1>
<p>Inside RaftProcess, there is a state called <code>RaftCore</code> and
many threads to process it concurrently on an event-driven basis,
most of them are driven by timers.</p>
<p><img src="images/multi-threading.png" alt=""></p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="application-state"><a class="header" href="#application-state">Application State</a></h1>
<p>In RaftCore, <code>RaftApp</code> and <code>RaftLogStore</code> are especially important because
these two compose the application state.
This section explains the conceptual aspect of it.</p>
<p><img src="images/application-state.png" alt=""></p>
<h2 id="raftapp"><a class="header" href="#raftapp">RaftApp</a></h2>
<p><code>RaftApp</code> is an abstraction that represents the FSM (Finite State Machine) of the application
and the snapshot repository.
The snapshot repository isn’t separated because the contents of the snapshot is
strongly coupled with the application state.</p>
<p>The application state can be updated by applying the log entries.
In this figure, the last applied entry is of index 55.</p>
<p><code>RaftApp</code> can generate a snapshot arbitrarily to compact the log.
When <code>RaftApp</code> makes a snapshot and stores it in the snapshot repository.
The latest snapshot is immediately picked up by the Raft process and it
manipulates the log (right in the figure) by replacing the snapshot entry.
In this figure, the snapshot index is 51.</p>
<p>Old snapshots will be garbage collected.</p>
<p>Snapshots may be fetched from other nodes.
This happens when the Raft process is far behind the leader and
the leader doesn’t have the log entries as they are garbage collected.</p>
<h2 id="raftlogstore"><a class="header" href="#raftlogstore">RaftLogStore</a></h2>
<p><code>RaftLogStore</code> is an abstraction that represents the log entries.
In the figure, log entries from 45 to 50 are scheduled for garbage collection.
snapshot entry is of index 51 and it is guaranteed that the corresponding snapshot
exists in the snapshot repository. 52 to 55 are applied.
56 or later are not applied yet. They are either uncommitted or committed.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="client-interaction"><a class="header" href="#client-interaction">Client Interaction</a></h1>
<p>You can send application-defined commands to the Raft cluster.</p>
<p>sorock distinguishes the command into two types: read-write and read-only.
The read-only command is called <strong>query</strong> and queries can be processed through the optimized path.</p>
<h2 id="rw-commnand"><a class="header" href="#rw-commnand">R/W commnand</a></h2>
<p>R/W command is a normal application command that is inserted into the log to be applied later.</p>
<p>You can send a R/W command to the cluster with this API.</p>
<pre><code class="language-proto">message WriteRequest {
  uint32 shard_index = 1;
  bytes message = 2;
  string request_id = 3;
}
</code></pre>
<p><strong>request_id</strong> is to avoid doubly application.
Let’s think about this scenario:</p>
<ol>
<li>The client sends a R/W command to add 1 to the value.</li>
<li>The leader server replicates the command to the followers but crashes before application (+response).</li>
<li>The client resends the command to a new leader after a timeout.</li>
<li>The result is adding 2 to the value whereas the expectation is 1.</li>
</ol>
<p>To avoid this issue, request_id is added to identify the commands.</p>
<h2 id="ro-command"><a class="header" href="#ro-command">R/O command</a></h2>
<p>The R/O command can bypass the log because it is safe to execute the query after the
commit index at query time is applied. This is called <strong>read_index</strong> optimization.</p>
<p>You can send a R/O command to the cluster with the following API.</p>
<p>When <code>read_locally</code> is set to true, the request isn’t proxied to the leader but
processed locally.</p>
<pre><code class="language-proto">message ReadRequest {
  uint32 shard_index = 1;
  bytes message = 2;
  bool read_locally = 3;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="cluster-management"><a class="header" href="#cluster-management">Cluster Management</a></h1>
<h2 id="single-server-change-approach"><a class="header" href="#single-server-change-approach">Single server change approach</a></h2>
<p>There are two approaches to membership change.
One is by joint consensus and the other is what is called <strong>single server change approach</strong>.
sorock implements the second one.</p>
<p>This approach exploits the log replication mechanism in membership change
and therefore can be implemented as an extension of the normal log replication
by defining AddServer and RemoveServer commands.
From the admin client, the following API can add or remove a Raft process in the cluster.</p>
<pre><code class="language-proto">message AddServerRequest {
  uint32 shard_index = 1;
  string server_id = 2;
}

message RemoveServerRequest {
  uint32 shard_index = 1;
  string server_id = 2;
}
</code></pre>
<h2 id="cluster-bootstrapping"><a class="header" href="#cluster-bootstrapping">Cluster bootstrapping</a></h2>
<p>In Raft, any command is directed to the leader.
So the question is how to add a Raft process to the empty cluster.</p>
<p>The answer is so-called <strong>cluster bootstrapping</strong>.
On receiving the AddServer command and the receiving node recognizes the cluster is empty,
the node tries to form a new cluster with itself and immediately becomes a leader as a result of a self election.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="leadership"><a class="header" href="#leadership">Leadership</a></h1>
<h2 id="command-redirection"><a class="header" href="#command-redirection">Command redirection</a></h2>
<p>Raft is a leader-based consensus algorithm.
Only a single leader can exist in the cluster at a time and
all commands are directed to the leader.</p>
<p>In sorock, if the receiving Raft process isn’t the leader,
the command is redirected to the leader.</p>
<h2 id="adaptive-leader-failure-detection"><a class="header" href="#adaptive-leader-failure-detection">Adaptive leader failure detection</a></h2>
<p>Detecting the leader’s failure is a very important issue in Raft algorithm.
The naive implementation can send heartbeats to the followers periodically and
followers can detect the leader’s failure by timeout.
However, this approach requires the heartbeat interval and the timeout duration
to be set properly before deployment. This brings another complexity.
Not only that, these times can’t be fixed to a single value when
the distance between nodes is heterogeneous such as geo-distributed environment.</p>
<p>To solve this problem, sorock uses an adaptive failure detection algorithm called
<strong>Phi accrual failure detector</strong>.
With this approach, users are free from setting the timing parameters.</p>
<h2 id="leadership-transfer-extension"><a class="header" href="#leadership-transfer-extension">Leadership transfer extension</a></h2>
<p>In multi-raft, changing the cluster members is not a rare case.
An example of this case is rebalancing:
To balance the CPU/disk usage between nodes, Raft process may be
moved to other nodes.</p>
<p>If the Raft process to be removed is the leader, the cluster will not have a
leader until a new leader is elected which causes downtime.</p>
<p>To mitigate this problem, the admin client can send a TimeoutNow command to
any remaining Raft process to forcibly start a new election (by promoting to a candidate in Raft term).</p>
<pre><code class="language-proto">message TimeoutNow {
  uint32 shard_index = 1;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="development"><a class="header" href="#development">Development</a></h1>
<h2 id="testing"><a class="header" href="#testing">Testing</a></h2>
<p><code>cargo test</code> to run unit tests.</p>
<h2 id="benchmark"><a class="header" href="#benchmark">Benchmark</a></h2>
<p><code>cargo +nightly bench</code> to run benchmarks.</p>
<h2 id="load-testing"><a class="header" href="#load-testing">Load Testing</a></h2>
<p>We have a nice load testing tool named “Mr. Bench”.
To ask him for a help, run <code>cargo run -p mrbench</code>.
For detail, please refer to the README.</p>
<h2 id="documentation"><a class="header" href="#documentation">Documentation</a></h2>
<p>For editing the mdbook under doc/ directory,
you can run <code>mdbook serve doc</code> to start the local mdbook server.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr-ef4e11c1.min.js"></script>
        <script src="mark-09e88c2c.min.js"></script>
        <script src="searcher-c2a407aa.js"></script>

        <script src="clipboard-1626706a.min.js"></script>
        <script src="highlight-abc7f01d.js"></script>
        <script src="book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->
        <script src="mermaid-33381bc2.min.js"></script>
        <script src="mermaid-init-4533fb11.js"></script>

        <script>
        window.addEventListener('load', function() {
            MathJax.Hub.Register.StartupHook('End', function() {
                window.setTimeout(window.print, 100);
            });
        });
        </script>


    </div>
    </body>
</html>
