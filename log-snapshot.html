<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Log and Snapshot - lol</title>
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "light" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="overview-architecture.html"><strong aria-hidden="true">1.</strong> Architecture</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="log-snapshot.html" class="active"><strong aria-hidden="true">1.1.</strong> Log and Snapshot</a></li><li class="chapter-item expanded "><a href="snapshot-tag.html"><strong aria-hidden="true">1.2.</strong> Snapshot Resource and Tag</a></li><li class="chapter-item expanded "><a href="snapshot-types.html"><strong aria-hidden="true">1.3.</strong> Snapshot Types (Copy and Fold)</a></li><li class="chapter-item expanded "><a href="storage-abstraction.html"><strong aria-hidden="true">1.4.</strong> Storage Abstraction</a></li><li class="chapter-item expanded "><a href="bridge.html"><strong aria-hidden="true">1.5.</strong> RaftApp Bridge</a></li></ol></li><li class="chapter-item expanded "><a href="client-interactions.html"><strong aria-hidden="true">2.</strong> Client Interactions</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="query-processing.html"><strong aria-hidden="true">2.1.</strong> Optimized Query Processing</a></li><li class="chapter-item expanded "><a href="gateway.html"><strong aria-hidden="true">2.2.</strong> Gateway</a></li></ol></li><li class="chapter-item expanded "><a href="cluster-management.html"><strong aria-hidden="true">3.</strong> Cluster Management</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="membership-change.html"><strong aria-hidden="true">3.1.</strong> Single-server changes</a></li></ol></li><li class="chapter-item expanded "><a href="election.html"><strong aria-hidden="true">4.</strong> Leader Election</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="failure-detection.html"><strong aria-hidden="true">4.1.</strong> Leader Failure Detection</a></li><li class="chapter-item expanded "><a href="timeout-now.html"><strong aria-hidden="true">4.2.</strong> Leadership Transfer Extension</a></li></ol></li><li class="chapter-item expanded "><a href="tools.html"><strong aria-hidden="true">5.</strong> Tools</a></li><li class="chapter-item expanded "><a href="references.html"><strong aria-hidden="true">6.</strong> References</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                    </div>

                    <h1 class="menu-title">lol</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                    </div>
                </div>

                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#log-and-snapshot" id="log-and-snapshot">Log and Snapshot</a></h1>
<p>To explain how I've designed the log and the snapshot in this library,
tracking the evolution of the design would be the quickest.</p>
<h2><a class="header" href="#v1-snapshot-as-a-log-entry" id="v1-snapshot-as-a-log-entry">v1: Snapshot as a log entry</a></h2>
<p>lol has started as a company project and it's aim is to 
replicate data in the same order in the cluster then we considered Raft would fit.
That was when my journey began.
The name &quot;lol&quot; comes from our project. (one of the two l means log but the another is secret)
Hornestly, it is not a joke.</p>
<p>Since our aim is to replicate the log, the log centric design is natural for me to start with.
Also, I don't like to implement InstallSnapshot RPC as described in Raft dissertation
because it would certainly introduce extra complexity to the software.</p>
<p>This way, the design v1 is drawn.</p>
<p><img src="images/log-v1.png" alt="" /></p>
<p>In this design, everything is a log entry. Everything includes not only the 
user command but snapshot and special entries to change the membership.
Log entry has a pair of term and index to the previous entry so to ensure the log consistency,
and the command payload in bytes for versatility.
Since everything is a log entry, everything in done under Raft's log replication mechanism.
This is so simple and easy to implement. But in terms of versatility, this design choice is not the optimimal.</p>
<p>Why is it not optimal? The main reason is the snapshot's size is limited by the
system memory since in replication
we must put in buffer to read or write the data
(Consider Put method in RocksDB).
We could avoid this by some implementation hacks like cutting snapshot payload into streaming chunks
but this would destroy the interfaces and not beatiful. Then we have to find a new design.</p>
<h2><a class="header" href="#v2-snapshot-inventory" id="v2-snapshot-inventory">v2: Snapshot Inventory</a></h2>
<p>The problem must root in the fact that we try to deal with completely different things, snapshot and normal entries, in the same way. That made me come up with the idea of <strong>snapshot inventory</strong>.</p>
<p>In Raft dissertation, InstallSnapshot RPC is PUSH operation because it is initiated in leader node and the snapshot chunks are sent in streaming to followers.</p>
<p>My idea is <em>completely the opposite</em>: <code>GetSnapshot</code> RPC is initiated by follower and leader sends back the snapshot in streaming after finding it in the snapshot inventory. This is a PULL operation.</p>
<p><img src="images/log-v2.png" alt="" /></p>
<p>In design v2, application snapshot is moved out of the snapshot entry and then put in snapshot inventory. The snapshot entry still exists and replicated to slow followers in the same way as in v1. The difference is: when follower received snapshot entry, it calls <code>GetSnapshot</code> RPC to the sender (in this case it must be a leader) to request the application snapshot in stream. When the <code>GetSnapshot</code> RPC is completed and the snapshot is stored in the snapshot inventory of its own, the follower node commits the snapshot entry just like the way filesystem firstly stores the file data and then metadata to complete the operation.</p>
<p>The greatest point of this algorithm is that leader node doesn't have to find slow nodes but slow node is noticed in the way of log replication. This makes the implemetation pretty simple and thus bug-free.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="overview-architecture.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="snapshot-tag.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="overview-architecture.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="snapshot-tag.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        
        
        
        <script type="text/javascript">
            window.playpen_copyable = true;
        </script>
        

        

        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
